import { Router } from 'itty-router'
import { projects } from './projects'
import { services, serviceMap, collect } from './services'

const router = Router({ base: '/downloads' })

function invalidRoute() {
  return new Response(JSON.stringify({ message: 'Not Found' }), {
    status: 404,
    headers: { 'Content-Type': 'application/json; charset=utf-8' },
  })
}

router.get('/:project/:service/:badge?', async (request) => {
  const { project, service, badge } = request.params
  const url = new URL(request.url)
  const { label = 'downloads', color = '#4c1', style = 'flat', logo = '', logoColor = '' } = Object.fromEntries(url.searchParams)
  if (typeof badge !== 'undefined' && badge !== 'badge') return invalidRoute()

  if (project in projects) {
    if (service in projects[project] || service === 'total') {
      let count: number = 0
      if (service === 'total')
        for (let i = 0; i < services.length; i++) {
          count += await collect(serviceMap[services[i]], projects[project][services[i]])
        }
      else count = await collect(serviceMap[service], projects[project][service])

      let message: string = ''
      if (count > 1000 * 1000) {
        message = Math.round(count / 1000000) + 'm'
      } else if (count > 1000) {
        message = Math.round(count / 1000) + 'k'
      } else {
        message = String(count)
      }

      // Return SVG or JSON
      if (badge) {
        let logoIn = logo
        let replaceLogo = ''
        // Hardcoded alternative logos
        switch (logo) {
          case 'wog':
            logoIn = 'github'
            replaceLogo =
              'PHN2ZyBmaWxsPSJ3aGl0ZXNtb2tlIiByb2xlPSJpbWciIHZpZXdCb3g9IjAgMCAxNzguNiAxOTguNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+V29ybGQgb2YgR290aGljPC90aXRsZT48cGF0aCBkPSJNMy42LDYzLjdjMy4zLTYuMyw0LTEzLjYsNy45LTE5LjZjNS4zLTguMiwxMi4zLTE0LjgsMjAtMjAuNmM4LTYuMSwxNi45LTEwLjgsMjUuOC0xNS40YzguOS00LjYsMTguNC02LjMsMjgtNy4zIGMxNS4xLTEuNiwzMC0wLjYsNDQuNiwzLjljNi4xLDEuOSwxMi4yLDQuMSwxNy41LDcuNWM0LjgsMyw5LjIsMy4yLDEzLjgsMGMzLTIuMSw2LTQuMSw4LjctNi41YzEuNy0xLjYsMy43LTMsNS43LTIuMSBjMS42LDAuOCwyLDMuMywyLDUuM2MwLDUuMiwwLjQsMTAuNC0wLjIsMTUuNWMtMC41LDQuMS0wLjIsOCwwLjgsMTEuOGMwLjUsMi4yLDAuNSw0LjMsMC40LDYuNGMtMC41LDYuNi0zLjcsOC4zLTkuNCw1LjIgYy02LjYtMy41LTExLjYtOS4zLTE4LjEtMTNjLTE2LjQtOS40LTMzLjUtMTQuOS01Mi44LTEyLjNjLTEzLjEsMS44LTIzLjYsOC4zLTMyLjYsMTcuMmMtNC41LDQuNS03LjMsMTAuOS0xMC43LDE2LjUgYy0yLjEsMy41LTYuMyw1LjYtNy41LDguN2MtMC45LDIuNCwyLjMsNi42LDIuMSwxMC40Yy0wLjUsNy42LTAuOSwxNS0wLjQsMjIuN2MwLjQsNywzLjYsMTIuNiw1LjMsMTguOCBjMy40LDEyLjQsMTEuMiwyMS4xLDIxLjcsMjcuOWM0LjQsMi45LDkuNCwyLjksMTQuMiwzLjdjOS43LDEuNiwxOS4zLDIuNCwyOC44LTEuN2MxNi42LTcuMiwyMy44LTE1LjksMjEuMi0zNS4yIGMtMS4xLTguMS04LjEtMTIuMy0xMy41LTE3LjNjLTEuOS0xLjctMy42LTMuNi0zLjEtNS43YzAuNi0yLjUsMy42LTEuOCw1LjctMS44YzEyLjgtMC4xLDI1LjctMC4xLDM4LjUsMGM2LjgsMCw4LjEsMS44LDguNyw4LjYgYzEuMSwxMy40LDAsMjYuOS0wLjIsNDAuM2MtMC4yLDE3LjgsMS4yLDM1LjYsMS4xLDUzLjRjMCwzLjUsMC41LDcuOS0yLjYsOS40Yy0yLjgsMS40LTUuNC0yLjMtNy44LTQuMmMtNy01LjQtMTQuNi0xMC4yLTIxLjQtMTUuOSBjLTYtNS04LTEwLjgtOC4zLTE3LjljLTAuMS0xLjcsMC0zLjMsMC01LjNjLTguOSw0LjktMTgsOC43LTI3LjUsMTEuM2MtOS40LDIuNi0xOS4xLDMtMjksMS45Yy04LjgtMS0xNy42LTEuOC0yNS41LTUuNSBjLTExLjEtNS4xLTIzLjUtOC4yLTMxLjgtMTguMmMtOS42LTExLjYtMTkuMS0yMy4yLTIwLjUtMzljMC0wLjMtMC40LTAuNS0wLjYtMC43Yy0yLTkuMi0zLjgtMTguNC0xLjUtMjggQzIuMSw3Mi40LDMuMSw2OC4xLDMuNiw2My43eiIvPjwvc3ZnPg0K'
            break
          case 'spine':
            logoIn = 'github'
            replaceLogo =
              'PHN2ZyBmaWxsPSJ3aGl0ZXNtb2tlIiByb2xlPSJpbWciIHZpZXdCb3g9IjAgMCAyMTYuNyAyNTAuOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+U3BpbmU8L3RpdGxlPjxwYXRoIGQ9Ik0xOTkuOCw4NC4yYzAuMy0wLjgsMC42LTEuNSwxLjEtMi44Yy0xLDAuNS0yLDAuNi0yLjQsMS4yYy0xLjEsMS4yLTEuOSwyLjctMi45LDQuMWMtMC42LTAuNi0wLjgtMC44LTEuMy0xLjMgYy0xLjMsMS40LTIuNSwyLjgtMy44LDQuMmMtMC4yLTAuMS0wLjQtMC4yLTAuNS0wLjNjMC4zLTAuNiwwLjQtMS4zLDAuOC0xLjljMC43LTEuMiwxLjUtMi4zLDIuMi0zLjRjLTAuOC0wLjgtMS41LTEuNS0yLjMtMi4zIGMtMS44LDAuOS0zLjYsMS44LTUuNywyLjljMC0yLjYsMi41LTMuMiwzLjMtNS40Yy0wLjctMC4zLTEuMy0wLjUtMi0wLjhjLTAuMiwwLjgtMC4zLDEuMy0wLjQsMS44Yy0wLjEsMC4xLTAuMiwwLjMtMC4zLDAuMyBjLTEuNSwwLjQtMi45LDAuNy00LjgsMS4yYzEuNC0xLjcsMi41LTMsMy42LTQuM2MtMC4yLTAuMi0wLjMtMC41LTAuNS0wLjdjLTAuNywwLjMtMS43LDAuNC0yLjIsMC45Yy0xLjEsMS4xLTIuMSwxLjQtMy41LDAuNyBjMS0xLjQsMS45LTIuOCwzLTQuNGMtMS45LDAtMy43LDAtNSwwYy0zLjYtMy42LTYuOS02LjktMTAtMTBjLTUuNS0wLjUtMTAuNi0xLTE2LjMtMS41YzIuNCwzLDQuMiw1LjYsNi4zLDcuOCBjMi4zLDIuNSw0LDUuMyw1LjIsOC4zYzEuMiwyLjgsMi4xLDUuOCwzLjIsOWMwLjYsMC4xLDEuNSwwLjIsMi40LDAuNGMtMS4yLDQuMy0xLjEsNC43LDIuMSw4YzAuNS0wLjQsMS0wLjcsMS40LTEuMSBjMC40LTAuMywwLjctMC43LDEuMS0xLjJjMS4zLDIuMS0xLDIuNS0xLjcsNC4xYzAuMywxLjEsMC43LDIuNiwxLjEsNGMyLjIsMCwzLjgsMCw1LjUsMGMwLjctMC42LDEuNS0xLjIsMi43LTIuMyBjLTAuMywzLjgtMy44LDMuOS01LjIsNi4xYzEuMSwxLjgsMi4yLDMuNywzLjQsNS41Yy0wLjYsMS4zLTEuMSwyLjQtMS44LDMuOWMtMi40LTAuNS00LjgtMC45LTcuMy0xLjQgYy0wLjYtOS44LTUuMy0xNy44LTEzLjctMjMuOGMtMy0yLjEtNS45LTQuMy04LjctNi43Yy00LjQtMy44LTYuOS05LTkuOC0xMy45Yy0wLjgtMS41LTEuNi0zLTIuNS00LjVjLTEuMy0yLjItMi4xLTQuOC0zLjMtNy43IGMyLjMtMS44LDQuOC0zLjcsNy42LTUuOWMwLTAuOCwwLTIuMSwwLTMuMmMxLTEuNSwxLjktMi43LDIuNy0zLjljMC41LDAuOSwxLjEsMS44LDEuNiwyLjdjMy44LDAuNyw3LjIsMC4yLDEwLjktMi41IGMwLjYtMS40LDEuNS0zLjcsMi40LTUuOGMxLjIsMC4yLDIuNSwwLjYsMy45LDAuNWMzLjktMC4xLDcuNSwwLjksMTAuNiwzLjRjMC41LDAuNCwxLjIsMC40LDEuNywwLjdjNC45LDIuNiw5LjgsNS4yLDE0LjcsNy45IGMwLjcsMC40LDEuMywxLDEuNiwxLjNjMC40LDQuNCwyLjMsNy44LDQuNiwxMC42YzEuMywxLjYsMy45LDIuNyw2LjEsMy4xYzMuMywwLjYsNS41LDIsNi45LDVjMC40LDAuOCwxLjQsMS40LDIsMi4xIGMxLjctMC40LDMuNC0wLjgsNS4xLTEuMmMxLjUsMy43LDIuOCw3LjIsNC4yLDEwLjhjLTAuNiwxLTEuMiwyLjItMiwzLjVjLTAuNS0wLjQtMC44LTAuNi0xLjUtMS4yYy0xLjgsMS0zLjcsMi4yLTUuNywzLjMgYy0wLjItMC4yLTAuMy0wLjMtMC41LTAuNWMwLjktMS4xLDEuOS0yLjIsMi44LTMuM2MtMC40LTAuNC0wLjctMC43LTEuMy0xLjNjLTAuNywwLjYtMS40LDEuNC0yLjMsMS45Yy0wLjksMC41LTEuOSwwLjctMy41LDEuMyBjMS0xLjYsMS43LTIuNiwyLjUtNGMtMC45LTAuMS0xLjYtMC40LTEuOC0wLjJjLTEuMSwwLjktMiwyLTMsM0MyMDAuMiw4NC41LDIwMCw4NC40LDE5OS44LDg0LjJ6IE0xNTcuNyw0My45IGMxLjMsNC42LDguMSwxNS4xLDkuNSwxMy45YzAsMCwwLjUtMC4yLDEtMC40YzAuOCwxLjIsMS40LDIuMiwyLjIsMy41YzEuNi0wLjUsMy0xLDQuNS0xLjVjLTEuNy0yLjItMy4yLTQuMS00LjctNi4xIGMtMS4xLDAuMy0yLjEsMC42LTMuMywxIi8+PHBhdGggZD0iTTEuMywxMTkuN2MyLjQsNCw1LjIsNy44LDcuMSwxMmMyLjUsNS40LDYsMTAuMSw4LjcsMTUuNGMzLjEsNi4xLDcsMTEuOCwxMC41LDE3LjdjMC45LDEuNCwxLjUsMywyLjIsNC40IGMtMi44LDEuOC01LjcsMy43LTguNyw1LjdjMyw1LjEsNS45LDEwLjIsOC45LDE1LjNjLTQuOCw0LjEtOS42LDguMy0xNC44LDEyLjhjLTQuMi0xMC4xLTguMy0xOS45LTEyLjMtMjkuOCBjMy4zLTIuMyw2LjUtNC42LDEwLjItNy4xYzAuMy0zLjMtMS4zLTYuNi0yLjItMTBjLTEuMi00LjYtMi41LTkuMy0zLjgtMTMuOWMtMS4xLTMuNy0yLjItNy40LTMuMi0xMS4yYy0wLjktMy44LTIuMS03LjUtMy4xLTExLjIgQzAuOCwxMTkuNywxLDExOS43LDEuMywxMTkuN3oiLz48cGF0aCBkPSJNMjEuOCwxMDEuOWMxLjIsMC4zLDIuMSwwLjUsMy4xLDAuN2MwLjksMC4yLDEuNywwLjQsMi42LDAuN2M2LjItNS41LDEyLjUtMTEuMSwxOC42LTE2LjZjNCw0LjQsNy45LDguNiwxMS44LDEyLjkgYy01LjksNS4zLTExLjcsMTAuNi0xNy45LDE2LjJjLTItMC40LTQuMy0wLjgtNi43LTEuM2MtMC42LDIuOC0xLjEsNS40LTEuNyw4LjZjLTEuOS0zLjktMy43LTcuMS01LjMtMTAuNSBDMjQuOCwxMDkuMSwyMy40LDEwNS41LDIxLjgsMTAxLjl6Ii8+PHBhdGggZD0iTTEwNC4zLDE0Ni43YzEuNSwwLDMuMSwwLDUuMSwwYzUuOC02LDkuOS0xMy40LDE1LjEtMjAuM2M1LjIsMi4zLDkuOSw1LjQsMTQuNiw5LjFjLTUuMiw3LjEtMTAuNSwxNC4yLTE1LjcsMjEuMyBjLTItMC41LTMuNi0wLjktNS4yLTEuM2MtMC40LDIuNC0wLjcsNC40LTEuMSw2LjhjMCwwLDAuMywwLjUsMSwxLjZjLTEuMS0wLjMtMS45LTAuMy0yLjEtMC43IEMxMTIuMSwxNTcuOCwxMDguMywxNTIuMywxMDQuMywxNDYuN3oiLz48cGF0aCBkPSJNMTQ5LjgsMTQ1LjVjMi45LDQuOCw1LjYsOS4zLDguNSwxNC4yYy02LjUsNS4xLTEzLjcsOS0yMC40LDE0LjFjLTItMC44LTQuMS0xLjYtNi4zLTIuNWMtMS41LDIuNC0xLDUuNS0zLjMsNy4zIGMtMi4xLTctNC4xLTEzLjktNi4zLTIxLjJjMS45LDAuOCwzLjUsMS42LDUuNCwyLjVDMTM1LjEsMTU1LjcsMTQxLjksMTUwLjIsMTQ5LjgsMTQ1LjV6Ii8+PHBhdGggZD0iTTEwNS42LDE0NC41Yy0xLjcsMC41LTMuNSwwLjktNS41LDEuNWMtMS4xLDIuMywwLjcsNC43LDEuMSw3LjljLTEuNy0xLjEtMy4xLTEuOC00LjEtMi43Yy0zLTIuNS01LjgtNS4yLTguOC03LjcgYy0xLjQtMS4yLTIuOS0yLjItNS40LTMuOWMzLjYsMC4yLDUuOS0wLjIsNy40LTEuN2MzLjEtNy43LDYtMTQuOSw5LjEtMjIuNmM1LjMsMi40LDEwLjksMy44LDE1LjcsNi44IEMxMTEuOCwxMjkuNiwxMDguNywxMzcsMTA1LjYsMTQ0LjV6Ii8+PHBhdGggZD0iTTYzLjksMTMxLjhjMS42LTAuMSwzLjEtMC4yLDQuOC0wLjNjMy4yLTcuNyw2LjMtMTUuNCw5LjYtMjMuM2M1LjUsMS45LDEwLjYsMy42LDE2LDUuNWMtMy4zLDguMy02LjUsMTYuMS05LjYsMjQgYy0xLjksMC0zLjcsMC02LDBjMC41LDMsMC45LDUuOCwxLjUsOS42Yy0yLjQtMi40LTMuOC00LjYtNS44LTUuNmMtMi40LTEuMS0zLjQtMy42LTUuNi00LjdjLTIuMy0xLjEtMy41LTMtNS40LTQuNCBDNjMuNSwxMzIuNCw2My43LDEzMi4xLDYzLjksMTMxLjh6Ii8+PHBhdGggZD0iTTE2Mi4yLDE3Ny42Yy0wLjQsNS44LTAuNywxMS4zLTEuMSwxNi45Yy04LjYsMC0xNi43LDAtMjQuNywwYy0xLTEuNy0yLTMuNC0zLjEtNS4zYy0yLjIsMS43LTQuMSwzLTYuNCw0LjggYzAtNC4yLDEuOS03LjIsMy0xMC42YzEtMy4yLDIuMS02LjQsMy4xLTkuNWMxLjQsMS40LDIuNywyLjcsMy42LDMuNkMxNDUuNCwxNzcuNiwxNTMuNCwxNzcuNiwxNjIuMiwxNzcuNnoiLz48cGF0aCBkPSJNNzQuOSw1LjljLTEsMS42LTIsMy4xLTMsNC43YzIuNCw3LjgsNC45LDE1LjYsNy40LDIzLjVjLTUuNCwxLjgtMTAuNSwzLjUtMTUuOSw1LjNjLTIuMi04LTUuOC0xNS45LTcuNi0yNC4xIGMxLjYtMS42LDIuOS0yLjksNC4xLTQuMWMtMi0xLjUtNC0zLjEtNi4yLTQuN0M1Ni43LDUuMyw2NS45LDUuMSw3NC45LDUuOXoiLz48cGF0aCBkPSJNMjQuNSwzOC40YzAuNiwyLDEuMSwzLjcsMS44LDYuMWM3LjEsMi42LDE0LjcsNS41LDIyLjQsOC4zYzEsMS45LTAuNiwzLjMtMS4zLDQuN2MtMS4zLDMtMi45LDYtMi40LDkuNCBjLTEsMS4zLTIuMSwyLjItMy44LDEuNGMtNi45LTMuMi0xNC4yLTUtMjEuMy04LjJjMC0xLjQsMC0yLjgsMC00LjFjLTAuNi0wLjYtMS4xLTEtMS44LTEuN2MtMi4yLDAuNy00LjYsMS41LTcuOCwyLjYgQzE1LjQsNTAuMywxOS45LDQ0LjQsMjQuNSwzOC40eiIvPjxwYXRoIGQ9Ik03NS44LDEwNy42Yy00LjgsNy40LTkuNSwxNC42LTE0LjMsMjJjLTEuNy0wLjQtMy41LTAuOC01LjYtMS4yYzAsMy4zLDAsNi4yLDAsOS42Yy00LjktNi05LjQtMTEuNS0xNC4yLTE3LjIgYzEuOCwwLDMuMiwwLDQuMywwYzMuNi0yLjUsNC44LTYuMiw2LjktOS40YzIuNC0zLjcsNC45LTcuMyw3LjMtMTFDNjUuNiwxMDIuOSw3MC44LDEwNS4zLDc1LjgsMTA3LjZ6Ii8+PHBhdGggZD0iTTE1LjEsNjcuOWMxLjMsMS45LDIuMSwzLjIsMy4yLDQuOGMyLjQtMC4yLDUuMiwwLjIsNy41LTAuN2MyLjUtMSw1LDAsNy42LTFjMy4xLTEuMyw2LjgtMC45LDEwLjctMS4zIGMtMC41LDUuMiwwLjcsMTAsMiwxNS4yYy0wLjUsMC41LTEuMiwxLjctMS44LDEuN2MtMS43LTAuMS0zLjEsMC44LTQuNiwxYy0zLjUsMC41LTcsMC43LTEwLjYsMS4xYy0yLjUsMC4zLTUsMC45LTcuNSwxLjMgYy0xLjItMS43LTIuMi0zLjEtMy4yLTQuNmMtMS41LDAuOS0yLjksMS41LTQuMSwyLjVjLTEsMC44LTEuNywyLTMuMSwzLjhDMTIuNSw4My4yLDEzLjcsNzUuOSwxNS4xLDY3Ljl6Ii8+PHBhdGggZD0iTTMzLjQsMjMwLjdjMy45LTcsOS0xMy4yLDEzLjEtMjAuM2MyLDAsNC4xLDAsNi40LDBjMC0yLjYsMC01LjEsMC04LjRjNSw2LDkuNCwxMS40LDE0LjMsMTcuM2MtMiwwLjEtMy43LDAuMi01LjksMC4zIGMtNS40LDUuOC04LjYsMTMuNy0xNC4xLDIwLjRDNDIuNywyMzcsMzguNCwyMzQuMSwzMy40LDIzMC43eiIvPjxwYXRoIGQ9Ik02MS44LDQxLjFjLTQuNSwzLTguOCw2LjQtMTEuNSwxMS43Yy02LjktNS41LTEyLjctMTEuOS0xOC4xLTE4LjdjMC42LTEuNSwxLjItMy4yLDEuOS01LjNjLTIuNy0wLjYtNS4yLTEuMS04LTEuNyBjMC0wLjItMC4xLTAuNi0wLjItMS4xYzYuNi0yLjEsMTIuMi02LDE4LjgtOC44YzAuMiwxLjksMC44LDMuNC0xLjEsNS4xQzQ5LjcsMjguNiw1NS43LDM0LjksNjEuOCw0MS4xeiIvPjxwYXRoIGQ9Ik02NS42LDIyMy4yYzEuNC0wLjYsMy4zLTEuMyw1LjQtMi4yYy0xLTIuMS0yLjEtNC41LTMuMy02LjhjMi40LTAuMiwxNC4zLDUuNCwxOS43LDkuM2MtMC43LDAuMy0xLjMsMC45LTEuOCwwLjkgYy0zLjktMC4yLTQuMywzLjEtNC42LDUuNGMtMC42LDQuMS0xLjUsOC4xLTIsMTIuMWMtMC4zLDIuNS0wLjksNS0xLjQsNy44Yy01LjYtMS4zLTExLjQtMS40LTE2LjQtNC4xYzAuNi0zLjgsMS4yLTcuMywxLjktMTAuOCBDNjMuNywyMzEuMiw2My45LDIyNy42LDY1LjYsMjIzLjJ6Ii8+PHBhdGggZD0iTTgxLjEsMzQuM2MxLjQtNy43LDIuNy0xNS40LDQuMi0yMy44YzEuNC0wLjYsMy4zLTEuNiw1LjUtMi42QzkwLDUuNyw4OSwzLjMsODcuNywwYzYuOSwzLjQsMTMsNi41LDE5LjgsOS45IGMtMi4xLDEuMi0zLjYsMi4xLTUuNSwzLjJjLTEuMSw2LjYtMi4zLDEzLjgtMy42LDIxLjZjLTAuNiwwLjItMiwxLjEtMi45LDAuN2MtNC41LTEuNy05LjEtMC41LTEzLjYtMC45IEM4MS42LDM0LjUsODEuNCwzNC40LDgxLjEsMzQuM3oiLz48cGF0aCBkPSJNMzIuOCwxOTNjMS41LDEuNSwzLjcsMC4yLDUuNiwwLjZjMS43LTIuMiwxLjYtNC42LDIuMS03YzMuMSw2LjQsNi4zLDEyLjksOS40LDE5LjNjMCwwLjEtMC4xLDAuMy0wLjMsMC41IGMtMi4xLTAuMy00LjItMC43LTYtMWMtNS44LDUuOC0xMS40LDExLjQtMTcuMiwxNy4yYy00LjMtMy45LTYuNC05LjQtOS40LTEzLjhDMjIuMiwyMDMuNSwyNy40LDE5OC40LDMyLjgsMTkzeiIvPjxwYXRoIGQ9Ik0xMjYuOCwyMTQuMmMwLTIuMiwwLTQuMywwLTYuM2MtMi42LDAuMy01LjEsMC42LTcuNSwwLjljNS01LDkuOC05LjgsMTQuNS0xNC41YzAuMywxLjEsMC45LDIuOSwxLjQsNC45IGM2LjgsMy40LDEzLjgsNywyMS4xLDEwLjZjLTIuNSw1LjItNS42LDkuNC04LjksMTQuMUMxNDAuMywyMjEuNCwxMzQuMSwyMTcuMiwxMjYuOCwyMTQuMnoiLz48cGF0aCBkPSJNODYuOSwyMjcuMWMxLjctMS4xLDMuMy0yLDUuMS0zLjFjLTEuNi0yLTMuMy00LjEtNS4zLTYuNmM3LjQsMSwxNC4xLDMuNSwyMC43LDQuM2MtMS4yLDEuMi0yLjYsMi42LTMuNSwzLjQgYzAsNC4zLTAuNyw3LjgsMC4yLDEwLjljMSwzLjgsMC41LDcuNCwwLjksMTFjLTAuNiwwLjYtMS4xLDEuMS0xLjUsMS41Yy0yLjQsMC4xLTQuNywwLTcuMSwwLjljLTIuMiwwLjgtNC44LTAuNy03LjQsMS4zIGMtMC40LTEuMS0wLjktMi4xLTEtMy4yYy0wLjEtMi41LDAuNi01LjItMC4yLTcuNEM4Ni4zLDIzNS43LDg3LjMsMjMxLjQsODYuOSwyMjcuMXoiLz48cGF0aCBkPSJNMTA4LjEsMjI2LjFjMC45LTEuOCwxLjgtMy41LDIuOC01LjVjLTIuMy0wLjktNC43LTEuOC03LjYtMi45YzAuOC0wLjYsMS4yLTEsMS42LTEuMmM1LjUtMS43LDExLTMuMiwxNi4xLTUuNyBjMC43LTAuMywxLjUtMC4zLDIuNi0wLjVjLTAuMywxLTAuNSwxLjgtMC44LDIuNWMtMC4zLDAuOS0wLjYsMS43LTEuMSwyLjljNC40LDYuMSw4LjksMTIuMywxMy42LDE4LjljLTQuNSwzLjYtOS4zLDYtMTQuNCw4LjEgYy0zLjMtMi00LjMtNS42LTYuNS04LjJDMTEyLjIsMjMxLjksMTEwLjIsMjI5LDEwOC4xLDIyNi4xeiIvPjxwYXRoIGQ9Ik0xMTIuOCw0NS4yYy0zLjctNC45LTkuMS02LjUtMTMuNy04LjljMy02LjUsNS45LTEyLjksOS4xLTE5LjdjMS42LDAsMy42LDAsNS45LDBjLTAuNC0yLjktMC43LTUuMy0xLTguMyBjNi4xLDMuOCw5LjgsMTAsMTUuOCwxNGMtMS45LDAuNi0zLjgsMS4xLTYuMSwxLjhDMTE5LjgsMzAuNiwxMTYuNSwzNy41LDExMi44LDQ1LjJ6Ii8+PHBhdGggZD0iTTEyMy43LDU4LjNjLTMuMi00LjgtNi04LjktOC44LTEzLjFjLTAuMS0wLjEsMC0wLjMsMC0wLjdjMy40LTQuMyw2LjktOC44LDEwLjctMTMuN2MxLjUsMCwzLjYsMCw2LjEsMGMwLTIuNCwwLTQuNiwwLTcuMiBjMy4xLDIuNyw2LDcuOCw5LjMsMTUuOGMtMC45LDAuMS0xLjYsMC4yLTIuOSwwLjNDMTMzLjYsNDUuNSwxMjguOSw1MS42LDEyMy43LDU4LjN6Ii8+PHBhdGggZD0iTTEzMC44LDE1LjZjMC4yLTQuNiwyLjctOS43LDAuMS0xNC45YzMuNiw2LjMsNi4xLDEyLjgsMTAsMTguNmMzLjksNS45LDcuOCwxMS43LDExLjgsMTcuN2MwLjgsMi4yLTAuMSw0LjMtMS44LDUuOSBjLTIuMSwyLTQuOSwxLjktNy44LDEuNmMtMC40LTIuNi0wLjgtNS4yLTEuMy03LjljLTAuMS0wLjQtMC41LTAuOC0wLjctMS4yQzEzNy44LDI5LDEzNC41LDIyLjYsMTMwLjgsMTUuNnoiLz48cGF0aCBkPSJNMTY3LjEsMjIuNmMwLjYsMC4xLDEuMywwLDEuNSwwLjNjMS4zLDEuOSwyLjUsNCwzLjksNS44YzEuNSwxLjgsMS4xLDQuMSwyLDYuMWMxLDIuNCwxLjYsNC45LDIuNiw3LjkgYy0xLTAuMy0xLjYtMC40LTIuMi0wLjdjLTAuNy0wLjMtMS4zLTAuNy0yLjEtMWMtMS0wLjQtMi4zLTAuNC0zLTEuMWMtMC45LTEtMS43LTIuNC0xLjctMy43Yy0wLjEtMy41LTIuNy03LTAuMi0xMC42IEMxNjguMiwyNS4xLDE2Ny40LDIzLjksMTY3LjEsMjIuNnoiLz48cGF0aCBkPSJNMTczLjcsOTQuNmMwLTAuOSwwLTEuOSwwLTMuM2MtMS45LDAuOS0zLjUsMS43LTUuNiwyLjZjLTAuMS0xLjgtMC4yLTMuNC0wLjMtNC40YzAuOC0xLjUsMS4zLTIuNiwyLjItNC4yIGMtMS40LDAuNi0yLjMsMC45LTMuNSwxLjRjLTIuMS0xLjYtMi4zLTQuMi0yLjgtNi44YzEuOSwwLDMuNiwwLDYsMGMxLjQsMSwzLjMsMi41LDUuMiw0QzE3NC42LDg3LjUsMTc1LjYsOTEuMiwxNzMuNyw5NC42eiIvPjxwYXRoIGQ9Ik0xNTIuOCw2My40YzMuNywwLjUsNy4xLDAuOSwxMS4yLDEuNGMxLjMsMS4xLDMuMSwyLjYsNSw0LjJjLTMuNSwxLjMtNS4xLDQuNC03LjUsNi4zQzE1OC44LDcxLjYsMTU2LDY3LjcsMTUyLjgsNjMuNHoiLz48cGF0aCBkPSJNMTg0LjcsMTA5LjRjLTEuOCwwLTMuNSwwLTUuNSwwYy0xLjItMS4yLTIuNS0yLjUtMy45LTMuOWMwLjgtMC42LDEuMS0wLjcsMS42LTEuMUMxNzkuMywxMDYuMiwxODEuMywxMDguOSwxODQuNywxMDkuNHoiLz48cGF0aCBkPSJNMTczLjcsOTRjMCwyLjUsMCw0LjUsMCw2LjNjLTIuNCwxLjEtMS40LTEuNy0zLTIuMWMwLjgtMC44LDEuNS0xLjMsMi0yQzE3My4xLDk1LjcsMTczLjMsOTUsMTczLjcsOTR6Ii8+PHBhdGggZD0iTTE2NC44LDc5YzAuMy0xLjIsMC41LTEuOCwwLjctMi40bDAuMywwLjRjMCwwLjEtMC41LDEuOC0wLjUsMS44TDE2NC44LDc5eiIvPjxwYXRoIGQ9Ik0xNjkuOSw3MS44YzAuNi0wLjEsMS4zLTAuMSwxLjktMC4yYzAsMC4yLDAsMC4xLDAsMC4zYy0wLjcsMC4xLTEuMSwwLjEtMS43LDAuMmMwLTAuMSwwLDAuMSwwLDBjMCwwLTQuNCw0LjgtNC40LDQuOCBsLTAuMy0wLjRDMTY1LjQsNzYuNSwxNjkuOSw3MS44LDE2OS45LDcxLjhDMTY5LjksNzEuOCwxNjkuOSw3MS45LDE2OS45LDcxLjh6Ii8+PHBhdGggZD0iTTE2Ny44LDcxLjVjMC4yLTAuMywwLjUtMC41LDAuNy0wLjhjMC4xLDAuMSwwLjIsMC4yLDAuMywwLjNjLTAuMywwLjItMC41LDAuNS0wLjgsMC43QzE2Ny45LDcxLjYsMTY3LjksNzEuNiwxNjcuOCw3MS41eiIvPjxwYXRoIGQ9Ik0xNzEsNzQuN2MtMC4yLDAuMy0zLjUsMy41LTMuNywzLjhjLTAuMS0wLjEtMC4yLTAuMi0wLjMtMC4zYzAuMy0wLjIsMy41LTMuNSwzLjgtMy43QzE3MC45LDc0LjYsMTcwLjksNzQuNiwxNzEsNzQuN3oiLz48cGF0aCBkPSJNMTczLDc1LjdjLTAuMiwwLjMtMi41LDIuNS0yLjcsMi44Yy0wLjEtMC4xLTAuMi0wLjItMC4zLTAuM2MwLjMtMC4yLDIuNS0yLjUsMi44LTIuN0MxNzIuOSw3NS42LDE3Mi45LDc1LjYsMTczLDc1Ljd6Ii8+PHBhdGggZD0iTTE2OCw3MS43Yy0wLjIsMC4zLTQuNSw0LjUtNC43LDQuOGMtMC4xLTAuMS0wLjItMC4yLTAuMy0wLjNjMC4zLTAuMiw0LjUtNC41LDQuOC00LjdDMTY3LjksNzEuNiwxNjcuOSw3MS42LDE2OCw3MS43eiIvPjxwYXRoIGQ9Ik0xNzIuOCw3NS41YzAuMi0wLjMsMC41LTAuNSwwLjctMC44YzAuMSwwLjEsMC4yLDAuMiwwLjMsMC4zYy0wLjMsMC4yLTAuNSwwLjUtMC44LDAuN0MxNzIuOSw3NS42LDE3Mi45LDc1LjYsMTcyLjgsNzUuNXoiLz48cGF0aCBkPSJNMC44LDExOS43Yy0wLjMtMC4yLTAuNS0wLjUtMC44LTAuN2MwLjEtMC4xLDAuMi0wLjIsMC4zLTAuM2MwLjIsMC4zLDAuNSwwLjUsMC43LDAuOEMwLjksMTE5LjYsMC45LDExOS42LDAuOCwxMTkuN3oiLz48cGF0aCBkPSJNMTcwLjgsNzQuNWMwLjItMC4zLDAuNS0wLjUsMC43LTAuOGMwLjEsMC4xLDAuMiwwLjIsMC4zLDAuM2MtMC4zLDAuMi0wLjUsMC41LTAuOCwwLjdDMTcwLjksNzQuNiwxNzAuOSw3NC42LDE3MC44LDc0LjV6Ii8+PC9zdmc+DQo='
            break
        }
        const url = `https://img.shields.io/badge/${label}-${message}-${color.replace(/#/g, '')}?style=${style}&logo=${logoIn}&logoColor=${logoColor.replace(/#/g, '')}`
        const response = await fetch(url, { headers: { Accept: 'image/svg+xml' } })
        let content = await response.text()
        if (replaceLogo) content = content.replace(/(?<=data:image\/svg\+xml;base64,)[^"]+/, replaceLogo)
        return new Response(content, { headers: { 'Content-Type': 'image/svg+xml; charset=utf-8' } })
      } else {
        const format: Record<string, string | number> = {
          schemaVersion: 1,
          label: label,
          message: message,
          color: color,
          style: style,
        }
        if (logo) format.logo = logo
        if (logoColor) format.logoColor = logoColor
        return new Response(JSON.stringify(format), { headers: { 'Content-Type': 'application/json; charset=utf-8' } })
      }
    }
  }

  return invalidRoute()
})

router.get('/', (request) => {
  const url = new URL(request.url)
  return new Response(
    JSON.stringify({
      downloads_url: `${url.origin}/downloads/{project_id}/{service_id}`,
      badge_url: `${url.origin}/downloads/{project_id}/{service_id}/badge{?label,color,style,logo,logoColor}`,
      service_ids: services.concat('total'),
      project_ids: Object.keys(projects),
    }),
    { status: 200, headers: { 'Content-Type': 'application/json; charset=utf-8' } }
  )
})

// 404 for everything else
router.all('*', invalidRoute)

export default router
